import ee from"./LineChart.15ce9c7e.js";import{l as te,a as ae,b as ie,r as ne}from"./useMitt.81ca58b0.js";import{cG as P,j as se,o as re,b8 as oe,C,a7 as z,M as le,m as me,bj as V,E as $,ds as _,F as ce,q as ue,r as S,s as O,t as U,N as de,O as pe,aW as k,z as x,v as M,w as N,y as R,d3 as he,R as ve}from"./index.d6323a8b.js";import{r as fe}from"./controller.api.50e8f0e1.js";const G=(s,r)=>{const u="YYYY-MM-DD HH:mm",p=s.value;if(!p||!p.length)return;let g=[],y=new Date().getTime()+6e4,v=0,f=0,d=0;const e=(m,c,a)=>{const T=P(c).format(u);let D=[];for(const h of r.value)if(m[h].switch){const b=m[h][a];D.push({panelType:h,date:T,value:b,bandMax:b+m[h].bandMax,bandMin:b+m[h].bandMin,timestamp:c})}else D.push({panelType:h,date:T,value:void 0,bandMax:void 0,bandMin:void 0,timestamp:c});return D};for(let m=0;m<p.length;m++){const c=p[m];if(c.btnType=="value"){let a=y+v*60*1e3,T=e(c,a,"startValue");g.push(...T),v+=c.duration,a=y+v*60*1e3,T=e(c,a,"endValue"),g.push(...T)}else c.btnType=="loop"?c.isRightLoop?(d--,d>0&&(m=f)):(f=m,d=c.loop):c.btnType=="reservation"&&c.date&&(y=new Date(c.date).getTime())}return g},Te=(s,r=500)=>{let u=null;return function(...p){u&&clearTimeout(u),u=setTimeout(()=>{s.apply(this,p)},r)}},ge=se({name:"ChartPanel",components:{LineChart:ee},props:{pageName:{type:String,default:()=>""}},setup(s){const{t:r}=re(),{pageName:u}=oe(s),p="YYYY-MM-DD HH:mm",g=C([]),y=C([]),v=C(),f=C(),d=C(!1),e=z({width:100,height:100,scale:0,tickCount:6,minTimestamp:0,maxTimestamp:0,initStartTimestamp:0,initEndTimestamp:0,dateType:"minute"});let m=500;le(()=>{m=v.value.clientHeight});const c=me(()=>{let t=[];return u.value=="Simulation"?t=g.value:u.value=="Protocol"&&(t=y.value),t}),a=z({dateArr:[],dateType:""}),T=V("changePanelRowList",["temperature","humidity","beam"]),D=V("changeDeviceObj",{}),h=C(),b=()=>{var l;if((l=D.value)!=null&&l.id){if(!a.dateArr||!a.dateArr.length)return _.warning(r("device.tips.pleaseChoseDate"));if(!a.dateType)return _.warning(r("device.tips.pleaseChoseDateType"))}else return _.warning(r("device.tips.pleaseChoseDevice"));const t=new Date(a.dateArr[0]).getTime(),i=new Date(a.dateArr[1]).getTime(),o=i-t;if(a.dateType=="minute"&&o>1728e5)return _.warning(r("device.tips.exceedTwoDay"));if((a.dateType=="minute"||a.dateType=="hour")&&o>7776e6)return _.warning(r("device.tips.exceed90Day"));e.minTimestamp=t,e.maxTimestamp=i,e.dateType=a.dateType,clearInterval(h.value),h.value=null,Y(),h.value=setInterval(()=>{Y()},6e4)},Y=()=>{var i;y.value=[],d.value=!0;const t={deviceId:(i=D.value)==null?void 0:i.id,startTime:a.dateArr[0],endTime:a.dateArr[1],type:a.dateType};fe(t).then(o=>{d.value=!1;let l=[];if(o&&o.length)for(const n of o)for(const w of T.value){let A=n.temperature,L=n.setTemperature,F=n.temperatureMax,I=n.temperatureMin;w=="humidity"?(A=n.humidity,L=n.setHumidity,F=n.humidityMax,I=n.humidityMin):w=="beam"&&(A=n.beam,L=n.setBeam,F=n.beamMax,I=n.beamMin);const X=new Date(n.date).getTime();let Z={panelType:w,date:n.date,value:A,setVal:L,bandMax:F,bandMin:I,timestamp:X};l.push(Z)}y.value=l,e.width=v.value.clientWidth,e.height=m,q("refresh")}).catch(()=>{d.value=!1})};$(D,()=>{if(u.value=="Protocol"){const t=new Date().getTime(),i=t-36e6,o=t+72e5,l=P(i).format(p),n=P(o).format(p);a.dateType="minute",a.dateArr=[l,n],b()}else setTimeout(()=>{const t=G(H,T);g.value=t,j(t)},100)});const H=C([]),W=V("changePageName");$(W,t=>{if(t=="Simulation"&&u.value=="Simulation"){const i=G(H,T);g.value=i,j(i)}});const J=C("temperature");te(t=>{J.value=t}),ae(t=>{H.value=t});const j=(t=[])=>{var l,n;const i=((l=t[0])==null?void 0:l.timestamp)||0,o=((n=t[t.length-1])==null?void 0:n.timestamp)||0;e.minTimestamp=i,e.maxTimestamp=o,e.initStartTimestamp=i,e.initEndTimestamp=o,e.width=v.value.clientWidth,e.height=m,E("restore")},K=u.value=="Simulation"?50:1e3,B=Te(t=>{e.width=v.value.clientWidth,u.value=="Protocol"?q(t):u.value=="Simulation"&&E(t),d.value=!1},K);ie(t=>{if(W.value==u.value){if(t=="reduce"&&e.scale<=-4)return _.warning(r("device.tips.hadMinimum"));d.value=!0,B(t)}});const Q=t=>{const i=t.wheelDelta<0?"reduce":"amplify";if(i=="reduce"&&e.scale<=-4)return _.warning(r("device.tips.hadMinimum"));d.value=!0,B(i)},q=t=>{let i=e.dateType,o=10*60*1e3;if(i=="hour"?o=60*60*1e3:i=="day"&&(o=24*60*60*1e3),t=="amplify"){const l=e.minTimestamp+o,n=e.maxTimestamp-o,A=Math.floor((e.width-120)/33)*60*1e3;if(n-l>A||e.scale<0)e.scale++,e.tickCount++,e.minTimestamp=l,e.maxTimestamp=n;else return _.warning(r("device.tips.dateNear"))}else t=="reduce"&&e.scale>-5?(e.scale--,e.tickCount>3&&e.tickCount--,e.minTimestamp-=o,e.maxTimestamp+=o):t=="restore"&&(e.scale=0,e.tickCount=6);if(t!="restore"&&t!="refresh"){const l=e.maxTimestamp-e.minTimestamp;l>=7776e6?i="day":l>=1728e5?i=i=="hour"||i=="day"?i:"hour":i="minute";const n=P(e.minTimestamp).format(p),w=P(e.maxTimestamp).format(p);a.dateType=i,a.dateArr=[n,w],b()}e.scale>-5&&(e.height=m+e.scale*50,f.value.changeChartSize(e))},E=t=>{if(t=="amplify"){const o=e.minTimestamp+6e4,l=e.maxTimestamp-6e4,w=Math.floor((e.width-120)/33)*60*1e3;if(l-o>w||e.scale<0)e.scale++,e.tickCount++,e.minTimestamp=o,e.maxTimestamp=l;else return _.warning(r("device.tips.dateNear"))}else t=="reduce"&&e.scale>-5?(e.scale--,e.tickCount>2&&e.tickCount--,e.minTimestamp-=6e4,e.maxTimestamp+=6e4):t=="restore"&&(e.scale=0,e.tickCount=6,e.minTimestamp=e.initStartTimestamp,e.maxTimestamp=e.initEndTimestamp);e.scale>-5&&(e.height=m+e.scale*50,f.value.changeChartSize(e))};return ce(()=>{clearInterval(h.value),h.value=null,ne()}),{t:r,queryParam:a,dataSource:g,maskLoading:d,realDataSource:y,chartWrapBoxRef:v,chartComponentRef:f,scaleObj:e,chartData:c,getRealValueList:Y,setIntervalFun:b,handleWheel:Q}}});const ye={class:"panel-wrap"},_e={class:"search-box"},we={class:"search-item"},Ce={class:"item-box"},Me={class:"item-box"},De={key:0,class:"load-mask"};function be(s,r,u,p,g,y){const v=S("a-range-picker"),f=S("a-select-option"),d=S("a-select"),e=S("a-button"),m=S("LineChart"),c=S("a-spin");return O(),U("div",ye,[de(k("div",_e,[k("div",we,[k("div",Ce,[k("span",null,x(s.t("device.chart.date"))+"\uFF1A",1),M(v,{value:s.queryParam.dateArr,"onUpdate:value":r[0]||(r[0]=a=>s.queryParam.dateArr=a),showTime:"",format:"YYYY-MM-DD HH:mm",valueFormat:"YYYY-MM-DD HH:mm"},null,8,["value"])]),k("div",Me,[k("span",null,x(s.t("device.chart.dateType"))+"\uFF1A",1),M(d,{value:s.queryParam.dateType,"onUpdate:value":r[1]||(r[1]=a=>s.queryParam.dateType=a)},{default:N(()=>[M(f,{value:"day"},{default:N(()=>[R(x(s.t("device.chart.day")),1)]),_:1}),M(f,{value:"hour"},{default:N(()=>[R(x(s.t("device.chart.hour")),1)]),_:1}),M(f,{value:"minute"},{default:N(()=>[R(x(s.t("device.chart.minute")),1)]),_:1})]),_:1},8,["value"])])]),M(e,{type:"primary",onClick:s.setIntervalFun},{default:N(()=>[R(x(s.t("device.chart.search")),1)]),_:1},8,["onClick"])],512),[[pe,s.pageName=="Protocol"]]),k("div",{ref:"chartWrapBoxRef",class:"scale-box",onWheel:r[2]||(r[2]=he((...a)=>s.handleWheel&&s.handleWheel(...a),["prevent"]))},[M(m,{ref:"chartComponentRef",pageName:s.pageName,chartData:s.chartData},null,8,["pageName","chartData"])],544),s.maskLoading?(O(),U("div",De,[M(c,{tip:"Loading...",size:"large"})])):ve("",!0)])}const Ne=ue(ge,[["render",be],["__scopeId","data-v-9b918ced"]]);export{Ne as default};
