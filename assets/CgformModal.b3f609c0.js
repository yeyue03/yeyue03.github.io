import{Z as F,j as Ke,I as Ve,C as g,m as ee,bB as te,bH as qe,a7 as Ue,bI as He,ev as ze,ez as L,M as z,b0 as Ge,r as f,s as w,Q as G,w as d,v as r,y as k,t as ae,ax as Ye,bc as Ze,z as We,R as le,aW as oe,x as Xe,ab as et,bZ as tt,u as at}from"./index.d6323a8b.js";import{B as lt}from"./index.d82ed84a.js";import{B as ot,u as nt}from"./useForm.c448380d.js";import"./componentMap.fc77c2dc.js";import{u as it}from"./useSchemas.59ec8797.js";import rt from"./DBAttributeTable.513ebdeb.js";import st from"./PageAttributeTable.cd9ec7ee.js";import ut from"./CheckDictTable.45449e83.js";import dt from"./ForeignKeyTable.806a23e4.js";import ct from"./IndexTable.ea07533e.js";import ft from"./QueryTable.16407c6a.js";import bt from"./ExtendConfigModal.ae506c30.js";import{u as pt,E as mt,a as Tt,V as I}from"./cgform.data.98e7370e.js";import{u as gt}from"./useOnlineTest.aee89632.js";import{g as yt}from"./useAutoForm.0cd9b496.js";import"./BasicModal.d35d2f99.js";import"./useWindowSizeFn.0b6b5a55.js";import"./BasicForm.vue_vue_type_style_index_0_lang.3b7179f6.js";import"./uniqBy.b473c125.js";import"./useFormItem.3a0d2c3a.js";import"./JUpload.vue_vue_type_style_index_0_lang.a2ed25c2.js";import"./api.47fd90c6.js";import"./download.17d84636.js";import"./base64Conver.030fa32c.js";import"./index.51946d8c.js";import"./index.6450ecda.js";import"./useCountdown.5d182bba.js";import"./areaDataUtil.8b289fd7.js";import"./props.184f6ff3.js";import"./index.e9877282.js";import"./bem.40e6f864.js";import"./props.5cd8551a.js";import"./useContextMenu.d4034b7b.js";import"./index.53758bc7.js";import"./onMountedOrActivated.f230a25e.js";import"./depart.api.2cd5c45f.js";import"./index.56d246a9.js";import"./validator.c70dd823.js";import"./user.api.2e174b62.js";import"./useTableSync.bfce54f9.js";import"./pick.b45371be.js";import"./_flatRest.4980c73e.js";import"./isArray.1617b935.js";import"./toString.79810c3b.js";import"./_arrayPush.ca89106e.js";import"./LinkTableConfigModal.26924f1b.js";import"./omit.bfcc4eee.js";import"./_baseClone.34614d7c.js";import"./_baseSlice.23bb44df.js";import"./LinkTableFieldConfigModal.4de2b43d.js";import"./FieldExtendJsonModal.aa409b75.js";import"./FormSchemaFactory.4bc99456.js";import"./JUploadModal.vue_vue_type_script_setup_true_lang.1a9447ac.js";import"./_commonjsHelpers.7ef9cff5.js";import"./customExpression.05dc2408.js";import"./OnlineSelectCascade.85298a8d.js";import"./BasicTable.0a886d20.js";import"./BasicTable.vue_vue_type_style_index_0_lang.fd294b48.js";import"./index.1430ee38.js";import"./useContentHeight.618fc37a.js";import"./useContentViewHeight.68b39758.js";import"./usePageContext.c54f47f4.js";import"./RedoOutlined.2aa4f93d.js";import"./useTable.2733e6a7.js";import"./useListPage.148819a1.js";import"./Area.b2923c7a.js";import"./LinkTableListPiece.85eca64f.js";import"./JModalTip.ba16ebfb.js";import"./EditOutlined.b6cbdd0d.js";var vt=Object.defineProperty,ht=Object.defineProperties,Ct=Object.getOwnPropertyDescriptors,ne=Object.getOwnPropertySymbols,Ft=Object.prototype.hasOwnProperty,_t=Object.prototype.propertyIsEnumerable,ie=(t,o,c)=>o in t?vt(t,o,{enumerable:!0,configurable:!0,writable:!0,value:c}):t[o]=c,x=(t,o)=>{for(var c in o||(o={}))Ft.call(o,c)&&ie(t,c,o[c]);if(ne)for(var c of ne(o))_t.call(o,c)&&ie(t,c,o[c]);return t},Dt=(t,o)=>ht(t,Ct(o)),_=(t,o,c)=>new Promise((E,h)=>{var b=p=>{try{C(c.next(p))}catch(m){h(m)}},D=p=>{try{C(c.throw(p))}catch(m){h(m)}},C=p=>p.done?E(p.value):Promise.resolve(p.value).then(b,D);C((c=c.apply(t,o)).next())});const Ua=t=>F.get({url:"/online/cgform/head/list",params:t}),Ha=t=>re(t,0),za=t=>re(t,1);function re(t,o){return F.delete({url:"/online/cgform/head/deleteBatch",params:{ids:t.join(","),flag:o}},{joinParamsToUrl:!0})}const Ga=(t,o)=>F.post({url:`/online/cgform/api/doDbSynch/${t}/${o}`,timeout:12e3,timeoutErrorMessage:"\u540C\u6B65\u6570\u636E\u5E93\u8D85\u65F6\uFF0C\u5DF2\u81EA\u52A8\u5237\u65B0"}),Ya=t=>F.post({url:`/online/cgform/head/copyOnline?code=${t}`}),Za=(t,o,c)=>F.get({url:`/online/cgform/head/copyOnlineTable/${t}`,params:x({tableName:o},c)}),$={doQueryField:(t,o)=>F.get({url:"/online/cgform/field/listByHeadId",params:x({headId:t},o)}),doQueryIndexes:(t,o)=>F.get({url:"/online/cgform/index/listByHeadId",params:x({headId:t},o)}),doSaveOrUpdate:(t,o)=>o?F.put({url:"/online/cgform/api/editAll",params:t}):F.post({url:"/online/cgform/api/addAll",params:t}),editHead:t=>F.put({url:"/online/cgform/head/edit",params:t})},Bt=Ke({name:"CgformModal",components:{BasicModal:lt,BasicForm:ot,DBAttributeTable:rt,PageAttributeTable:st,CheckDictTable:ut,ForeignKeyTable:dt,IndexTable:ct,QueryTable:ft,ExtendConfigModal:bt,Icon:Ve},emits:["success","register"],props:{actionButton:{type:Boolean,default:!0,required:!1}},setup(t,{emit:o}){const{createMessage:c}=at(),E=g(),h=g(!1);let b={};const D=ee(()=>h.value?"\u7F16\u8F91":"\u65B0\u589E"),C=g(!0),p=g(!1),m=g("dbTable"),O=g(!0),u={dbTable:g(),pageTable:g(),checkTable:g(),fkTable:g(),idxTable:g(),queryTable:g()},J=ee(()=>{var e,a;return(a=(e=E.value)==null?void 0:e.fullScreenRef)!=null?a:!1});te("tables",u),te("fullScreenRef",J);const{formSchemas:Q}=it(t,{onTableTypeChange:he,onIsTreeChange:Ce,ifShowOfSubTableStr:()=>Y}),[K,A]=nt({schemas:Q,showActionButtonGroup:!1,labelAlign:"right"}),{resetFields:V,setFieldsValue:S,validate:N}=A,[q,{closeModal:U}]=qe(e=>{var a;h.value=(a=e==null?void 0:e.isUpdate)!=null?a:!1,h.value?Z(e==null?void 0:e.record):pe()}),P=g("");let y=Ue({});const v=tt(()=>Fe(),150);let M=[],Y=!1,j=!1,B=[];const{aiTestMode:se,aiTestTable:ue,aiTableList:de,initVirtualData:ce,tableJsonGetHelper:fe,refreshCacheTableName:be}=gt();function pe(){Z({})}function Z(e){return _(this,null,function*(){var a;if(C.value=!1,m.value="dbTable",yield V(),b=Object.assign({},e),ye(b),fe(b),ge(b),S(b),P.value=b.tableName,L(1,()=>O.value=!1),h.value)(a=u.dbTable.value)==null||a.setDataSource([]),yield me(b.id),yield Te(b.id),yt(u.pageTable).then(()=>{u.pageTable.value.changePageType(b.tableType==3)});else{let{initialData:l,tempIds:n}=pt();yield W(l,!0),M=n}})}function me(e){return _(this,null,function*(){p.value=!0;try{let a=yield $.doQueryField(e);p.value=!1,yield W(a)}finally{p.value=!1}})}function Te(e){return _(this,null,function*(){let a=yield $.doQueryIndexes(e);u.idxTable.value.setDataSource(a)})}function ge(e){let a={};if(e.extConfigJson)try{a=JSON.parse(e.extConfigJson)}catch(l){console.error("online\u6269\u5C55JSON\u8F6C\u6362\u5931\u8D25\uFF1A",l)}y=Object.assign({},mt,a,{isDesForm:e.isDesForm||"N",desFormCode:e.desFormCode||""})}function ye(e){j=e.isTree=="Y",Y=e.tableType===2}function W(e,a){return _(this,null,function*(){const{dbTable:l,pageTable:n,checkTable:s,fkTable:i,queryTable:T}=u;l.value||(yield z(),yield L(1)),l.value.setDataSource(e,a),setTimeout(()=>{n.value.setDataSource(e,a),s.value.setDataSource(e,a),i.value.setDataSource(e,a),T.value.setDataSource(e,a)},10)})}function ve(e){if(["pageTable","checkTable","fkTable","idxTable","queryTable"].indexOf(e)!==-1){const a=u.dbTable,l=u[e];a.value.tableRef.resetScrollTop(),l.value.syncTable(a)}}function he(e){e===1&&S({themeTemplate:"normal"}),u.pageTable.value.changePageType(e==3)}function Ce(e){e==="Y"?Ae():we()}function H(){v()}function Fe(){return _(this,null,function*(){let{dbTable:e,pageTable:a,checkTable:l,fkTable:n,queryTable:s}=u;yield a.value.syncTable(e),yield l.value.syncTable(e),yield n.value.syncTable(e),yield s.value.syncTable(e)})}function _e(){H()}function De(){H()}function Be(e){let{oldIndex:a,newIndex:l}=e;Re(a,l)}function ke(e){return _(this,null,function*(){let{insertIndex:a,row:l}=e,{pageTable:n,checkTable:s,fkTable:i,queryTable:T}=u;n.value.tableRef.insertRows(l,a),s.value.tableRef.insertRows(l,a),i.value.tableRef.insertRows(l,a),T.value.tableRef.insertRows(l,a)})}function Re(e,a){let{pageTable:l,checkTable:n,fkTable:s,queryTable:i}=u;l.value.tableRef.rowResort(e,a),n.value.tableRef.rowResort(e,a),s.value.tableRef.rowResort(e,a),i.value.tableRef.rowResort(e,a)}function Ee(e){u.pageTable.value.syncFieldShowType(e.row)}function Oe(e){u.pageTable.value.enableQuery(e)}function Ae(){if(!j){let{dbTable:e,pageTable:a,checkTable:l}=u,n=Tt();n=n.filter(s=>!e.value.tableRef.getTableData().map(T=>T.dbFieldName).includes(s.dbFieldName)),B=[],n.forEach(s=>{let i=Ge()+"__tempId";B.push(i),s.id=i}),e.value.tableRef.addRows(n,{setActive:!1}),a.value.tableRef.addRows(n,{setActive:!1}),l.value.tableRef.addRows(n,{setActive:!1}),z(()=>H()),j=!0}z(()=>{A.setFieldsValue({treeIdField:"has_child",treeParentIdField:"pid"})})}function we(){if(B&&B.length>0){let{dbTable:e}=u;e.value.tableDeleteLines(B),B=[],j=!1}}function Ie(){let e={};return new Promise((a,l)=>{N().then(n=>a({values:n}),()=>l(I))}).then(a=>(Object.assign(e,a),Se())).then(a=>{Object.assign(e,a);let l=Ne(e);return Pe(l)}).catch(a=>(a===I||(a==null?void 0:a.code)===I?c.warning("\u6821\u9A8C\u672A\u901A\u8FC7"):console.error(a),Promise.reject(null)))}function Se(){return new Promise((e,a)=>_(this,null,function*(){let l=Object.keys(u),n={};for(let s=0;s<l.length;s++){let i=l[s],T=u[i];try{n[i]=yield T.value.validateData(i)}catch(R){R.code===I?m.value=R.activeKey:console.error(R),a(R);return}}e(n)}))}function Ne(e){let a={head:{},fields:[],indexs:[],deleteFieldIds:[],deleteIndexIds:[]};return a.head=Object.assign(b,e.values),a.head.isDesForm=y.isDesForm,a.head.desFormCode=y.desFormCode,delete y.isDesForm,delete y.desFormCode,a.head.extConfigJson=JSON.stringify(y),e.dbTable.tableData.forEach((l,n)=>{let s=l.id,i=Object.assign({},l),T=e.pageTable.tableData[n];i=Object.assign(T,i);let R=e.checkTable.tableData[n];i=Object.assign(R,i);let Je=e.fkTable.tableData[n];i=Object.assign(Je,i);let Qe=e.queryTable.tableData[n];i=Object.assign(Qe,i),s==null||s===""?delete i.id:i.id=s,[].concat(M,B).includes(i.id)&&delete i.id,a.fields.push(i)}),a.deleteFieldIds=e.dbTable.deleteIds,a.indexs=e.idxTable.tableData,a.deleteIndexIds=e.idxTable.deleteIds,a}function Pe(e){return new Promise((a,l)=>{let n=e.fields,s=!0;if(n&&n.length>0){let i=0;for(let T=0;T<n.length;T++)if((n[T].mainField||n[T].mainTable)&&(i+=1),i>1){s=!1;break}}s?a(e):l({code:-1,msg:"\u5916\u952E\u53EA\u5141\u8BB8\u914D\u7F6E\u4E00\u4E2A!",error:I})})}function Me(){C.value=!0,Ie().then(e=>_(this,null,function*(){var a;if(e.fields&&e.fields.length>0)for(let l of e.fields)l.dbFieldName=l.dbFieldName.toLowerCase().trim();(a=e.head)!=null&&a.tableName&&(e.head.tableName=e.head.tableName.toLowerCase().trim()),yield $.doSaveOrUpdate(e,h.value),be(P.value,e.head.tableName),o("success"),L(1,()=>X())}),e=>{console.error(e)}).finally(()=>{C.value=!1})}const[je,Le]=He();function $e(e){return _(this,null,function*(){if(y=e,h.value==!0){let a=et(y);const l={id:b.id,extConfigJson:JSON.stringify(a)};yield $.editHead(l),o("success")}})}function xe(){Le.openModal(!0,{extConfigJson:y})}function X(){O.value=!0,L(1,()=>U())}return Dt(x({},u),{modalRef:E,title:D,confirmLoading:C,tableLoading:p,activeKey:m,onCancel:X,extConfigJson:y,formAction:A,hideTabs:O,onSubmit:Me,onTabsChange:ve,onTableAdded:_e,onTableRemoved:De,onTableDragged:Be,onTableInserted:ke,onTableSyncDbType:Ee,onTableQuery:Oe,onOpenExtConfig:xe,onExtConfigOk:$e,registerForm:K,registerModal:q,registerExtendConfigModal:je,aiTestMode:se,aiTestTable:ue,aiTableList:de,initVirtualData:ce})}}),kt={style:{flex:"1","text-align":"right"}},Rt={key:0,style:{display:"inline-block","text-align":"left",position:"absolute",left:"0"}};function Et(t,o,c,E,h,b){const D=f("a-button"),C=f("BasicForm"),p=f("DBAttributeTable"),m=f("a-tab-pane"),O=f("PageAttributeTable"),u=f("CheckDictTable"),J=f("ForeignKeyTable"),Q=f("IndexTable"),K=f("Icon"),A=f("a-tooltip"),V=f("QueryTable"),S=f("a-tabs"),N=f("a-spin"),q=f("a-select-option"),U=f("a-select"),P=f("ExtendConfigModal"),y=f("BasicModal");return w(),G(y,Xe({ref:"modalRef",title:t.title,width:1200,maskClosable:!1,defaultFullscreen:!0,confirmLoading:t.confirmLoading},t.$attrs,{onCancel:t.onCancel,onRegister:t.registerModal}),{footer:d(()=>[r(D,{onClick:t.onCancel},{default:d(()=>[k("\u5173\u95ED")]),_:1},8,["onClick"]),r(D,{type:"primary",loading:t.confirmLoading,preIcon:"ant-design:save",onClick:t.onSubmit},{default:d(()=>[k("\u4FDD\u5B58")]),_:1},8,["loading","onClick"]),t.aiTestMode?(w(),ae("div",Rt,[r(U,{value:t.aiTestTable,"onUpdate:value":o[1]||(o[1]=v=>t.aiTestTable=v),placeholder:"\u8BF7\u9009\u62E9\u6D4B\u8BD5\u7684\u8868\u7C7B\u578B",getPopupContainer:v=>v.parentElement,style:{width:"250px",margin:"0 10px 0 20px"}},{default:d(()=>[(w(!0),ae(Ye,null,Ze(t.aiTableList,(v,M)=>(w(),G(q,{key:M,value:v.name},{default:d(()=>[k(We(v.title+"\uFF08"+v.name+"\uFF09"),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","getPopupContainer"]),r(D,{type:"primary",ghost:"",onClick:t.initVirtualData},{default:d(()=>[k("\u751F\u6210\u6570\u636E>>")]),_:1},8,["onClick"])])):le("",!0)]),default:d(()=>[r(N,{wrapperClassName:"p-2",spinning:t.confirmLoading},{default:d(()=>[r(C,{onRegister:t.registerForm},{extConfigButton:d(()=>[oe("div",kt,[r(D,{preIcon:"ant-design:setting",onClick:t.onOpenExtConfig},{default:d(()=>[k("\u6269\u5C55\u914D\u7F6E")]),_:1},8,["onClick"])])]),_:1},8,["onRegister"]),r(N,{spinning:t.tableLoading||t.hideTabs},{default:d(()=>[t.hideTabs?le("",!0):(w(),G(S,{key:0,activeKey:t.activeKey,"onUpdate:activeKey":o[0]||(o[0]=v=>t.activeKey=v),animated:"",onChange:t.onTabsChange},{default:d(()=>[r(m,{tab:"\u6570\u636E\u5E93\u5C5E\u6027",key:"dbTable",forceRender:""},{default:d(()=>[r(p,{ref:"dbTable",actionButton:t.actionButton,onAdded:t.onTableAdded,onRemoved:t.onTableRemoved,onDragged:t.onTableDragged,onInserted:t.onTableInserted,onSyncDbType:t.onTableSyncDbType},null,8,["actionButton","onAdded","onRemoved","onDragged","onInserted","onSyncDbType"])]),_:1}),r(m,{tab:"\u9875\u9762\u5C5E\u6027",key:"pageTable",forceRender:""},{default:d(()=>[r(O,{ref:"pageTable"},null,512)]),_:1}),r(m,{tab:"\u6821\u9A8C\u5B57\u6BB5",key:"checkTable",forceRender:""},{default:d(()=>[r(u,{ref:"checkTable"},null,512)]),_:1}),r(m,{tab:"\u5916\u952E",key:"fkTable",forceRender:""},{default:d(()=>[r(J,{ref:"fkTable",actionButton:t.actionButton},null,8,["actionButton"])]),_:1}),r(m,{tab:"\u7D22\u5F15",key:"idxTable",forceRender:""},{default:d(()=>[r(Q,{ref:"idxTable",actionButton:t.actionButton},null,8,["actionButton"])]),_:1}),r(m,{key:"queryTable",forceRender:""},{tab:d(()=>[oe("span",null,[k(" \u4E2A\u6027\u67E5\u8BE2\u914D\u7F6E "),r(A,null,{title:d(()=>[k("\u81EA\u5B9A\u4E49\u67E5\u8BE2\u5B57\u6BB5\u63A7\u4EF6\u6548\u679C")]),default:d(()=>[r(K,{icon:"bx:help-circle"})]),_:1})])]),default:d(()=>[r(V,{ref:"queryTable",onQuery:t.onTableQuery},null,8,["onQuery"])]),_:1})]),_:1},8,["activeKey","onChange"]))]),_:1},8,["spinning"])]),_:1},8,["spinning"]),r(P,{onRegister:t.registerExtendConfigModal,parentForm:t.formAction,onOk:t.onExtConfigOk},null,8,["onRegister","parentForm","onOk"])]),_:1},16,["title","confirmLoading","onCancel","onRegister"])}var Ot=ze(Bt,[["render",Et]]),Wa=Object.freeze(Object.defineProperty({__proto__:null,default:Ot},Symbol.toStringTag,{value:"Module"}));export{Ot as C,Ha as a,za as b,Ga as c,Ya as d,Za as e,Wa as f,Ua as l};
